<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Admin — Contributions</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  </head>
  <body>
    <h2>Contributions (Admin)</h2>
    <main style="max-width:1100px;margin:18px auto;padding:8px;">
      <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <strong>Target:</strong> Ksh {{ summary.target_amount | default(0) }}
          </div>
        <div>
          <strong>Raised:</strong> Ksh {{ summary.total_contributed | default(0) }}
        </div>
        <div>
          <a href="{{ url_for('export_contributions') }}" class="btn">Export CSV</a>
        </div>
      </div>

        <div style="margin-top:12px;">
          {% if updated %}
            <div style="padding:8px;background:#e6ffed;border:1px solid #b7f0c6;border-radius:6px;margin-bottom:8px">Target updated successfully.</div>
          {% endif %}
          <form method="post" action="{{ url_for('admin_set_target') }}" style="display:flex;gap:8px;align-items:center;">
            <label for="target_amount">Set target (Ksh):</label>
            <input id="target_amount" name="target_amount" type="number" step="0.01" required value="{{ summary.target_amount }}" style="padding:6px">
            <button type="submit" class="btn">Save Target</button>
          </form>
        </div>

      <table style="width:100%;border-collapse:collapse;margin-top:12px;">
        <thead>
          <tr>
            <th style="text-align:left;padding:8px;border-bottom:1px solid #ddd">When</th>
            <th style="text-align:left;padding:8px;border-bottom:1px solid #ddd">From</th>
            <th style="text-align:right;padding:8px;border-bottom:1px solid #ddd">Amount</th>
            <th style="text-align:left;padding:8px;border-bottom:1px solid #ddd">Method</th>
          </tr>
        </thead>
        <tbody>
          {% for p in payments %}
          <tr>
            <td style="padding:8px;border-bottom:1px solid #f1f1f1">{{ p.timestamp }}</td>
            <td style="padding:8px;border-bottom:1px solid #f1f1f1">{{ p.from_name }}</td>
            <td style="padding:8px;border-bottom:1px solid #f1f1f1;text-align:right">{{ p.amount }}</td>
            <td style="padding:8px;border-bottom:1px solid #f1f1f1">{{ p.method }}</td>
          </tr>
          {% else %}
          <tr><td colspan="4" style="padding:12px">No contributions yet.</td></tr>
          {% endfor %}
        </tbody>
      </table>
      
      <section style="margin-top:18px;">
        <h3>Manage Campaigns</h3>
        <form id="create-campaign" method="post" action="{{ url_for('create_campaign_route') }}" style="display:flex;gap:8px;align-items:center;">
          <input name="title" placeholder="Campaign title" required style="padding:6px">
          <input name="target_amount" placeholder="Target (Ksh)" required type="number" step="0.01" style="padding:6px">
          <button type="submit" class="btn">Create</button>
        </form>

        <div style="margin-top:10px;">
          <strong>Existing campaigns</strong>
          <ul style="list-style:none;padding-left:0;margin-top:8px">
            {% for c in campaigns %}
              <li style="padding:8px;border:1px solid #eee;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center;">
                <div>
                  <strong>{{ c.title }}</strong> — Ksh {{ c.target_amount }} {% if c.status == 'active' %}<em>(active)</em>{% endif %}
                </div>
                <div style="display:flex;gap:6px;">
                  <form method="post" action="{{ url_for('activate_campaign', campaign_id=c.id) }}" style="display:inline">
                    <button type="submit" class="btn">Activate</button>
                  </form>
                  <form method="post" action="{{ url_for('update_campaign_status', campaign_id=c.id) }}" style="display:inline">
                    <input type="hidden" name="status" value="pending">
                    <button type="submit" class="btn">Pending</button>
                  </form>
                  <form method="post" action="{{ url_for('update_campaign_status', campaign_id=c.id) }}" style="display:inline">
                    <input type="hidden" name="status" value="finished">
                    <button type="submit" class="btn">Finish</button>
                  </form>
                  <form method="post" action="{{ url_for('update_campaign_status', campaign_id=c.id) }}" style="display:inline">
                    <input type="hidden" name="status" value="canceled">
                    <button type="submit" class="btn">Cancel</button>
                  </form>
                </div>
              </li>
            {% else %}
              <li>No campaigns yet.</li>
            {% endfor %}
          </ul>
        </div>
      </section>
      <section style="margin-top:18px;">
        <h3>Recent Audits</h3>
        <div style="margin-top:8px;">
          {% if audits and audits|length > 0 %}
            <ul style="list-style:none;padding-left:0;margin-top:8px">
              {% for a in audits %}
                <li style="padding:8px;border:1px solid #f4f4f4;margin-bottom:6px">
                  <div style="font-size:0.95em;color:#333">{{ a.timestamp }} — <strong>{{ a.action }}</strong> by {{ a.actor or 'system' }}</div>
                  <div style="font-size:0.9em;color:#666">Campaign: {{ a.campaign_id }} | {{ a.old_status }} → {{ a.new_status }}</div>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <div style="padding:8px;color:#666">No audit records yet.</div>
          {% endif %}
        </div>
      </section>
    </main>
  </body>
</html>
